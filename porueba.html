<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mención Automática con !so</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #18181B;
            color: white;
        }
        #clipContainer {
            margin-top: 20px;
        }
        .clip-player {
            width: 560px;
            height: 315px;
            margin: auto;
        }
    </style>
</head>
<body>

    <h1>Mención Automática con !so</h1>
    <div id="clipContainer"></div>

    <script>
        const CLIENT_ID = "gp762nuuoqcoxypju8c569th9wz7q5";  
        const ACCESS_TOKEN = "89sdo43ita231wf0810v5aqdqudvn6";  
        const CHANNEL_NAME = "el_afap";  // Canal donde se leerán los mensajes
        const BROADCASTER_ID = "506013063"; // ID del broadcaster (canal que está transmitiendo)
        const SENDER_ID = "506013063"; // ID de tu bot en Twitch

        // Conectar a Twitch Chat usando WebSockets
        const socket = new WebSocket("wss://irc-ws.chat.twitch.tv");

        socket.onopen = () => {
            console.log("Conectado a Twitch Chat");
            socket.send(`PASS oauth:${ACCESS_TOKEN}`);  // Reemplaza con el token de tu bot
            socket.send(`NICK BOT_NOMBRE`);          // Nombre del bot
            socket.send(`JOIN #${CHANNEL_NAME}`);    // Canal al que se une
        };

        socket.onmessage = async (event) => {
            const message = event.data;
            if (message.includes("PRIVMSG")) {
                const userMessage = message.split("PRIVMSG")[1].split(":")[1]?.trim();
                console.log("Mensaje recibido:", userMessage);

                if (userMessage.startsWith("!so ")) {
                    let channelToShoutout = userMessage.split(" ")[1]; // Extrae el canal
                    console.log("Mención a:", channelToShoutout);

                    // Eliminar el '@' si está presente
                    if (channelToShoutout.startsWith('@')) {
                        channelToShoutout = channelToShoutout.slice(1);
                    }

                    if (channelToShoutout) {
                        getRandomClip(channelToShoutout);
                        sendMessageToChat(`¡Vayan a seguir a twitch.tv/${channelToShoutout}!`);
                    } else {
                        sendMessageToChat("No se pudo procesar la mención. Por favor, inténtalo de nuevo.");
                    }
                }
            }
        };

        async function getChannelId(channelName) {
            const response = await fetch(`https://api.twitch.tv/helix/users?login=${channelName}`, {
                headers: {
                    "Client-ID": CLIENT_ID,
                    "Authorization": `Bearer ${ACCESS_TOKEN}`
                }
            });
            const data = await response.json();
            return data.data.length > 0 ? data.data[0].id : null;
        }

        async function getClips(channelId) {
            const response = await fetch(`https://api.twitch.tv/helix/clips?broadcaster_id=${channelId}&first=10`, {
                headers: {
                    "Client-ID": CLIENT_ID,
                    "Authorization": `Bearer ${ACCESS_TOKEN}`
                }
            });
            const data = await response.json();
            return data.data;
        }

        async function getRandomClip(channelName) {
            const channelId = await getChannelId(channelName);
            if (!channelId) {
                console.error("Canal no encontrado.");
                sendMessageToChat("No se encontró el canal. Por favor, verifica el nombre.");
                return;
            }

            const clips = await getClips(channelId);
            if (clips.length === 0) {
                console.error("No hay clips disponibles.");
                sendMessageToChat("No se encontraron clips disponibles en el canal.");
                return;
            }

            const randomClip = clips[Math.floor(Math.random() * clips.length)];
            const embedUrl = `https://clips.twitch.tv/embed?clip=${randomClip.id}&parent=${window.location.hostname}&autoplay=true&muted=false`;

            // Usar iframe para cargar el clip
            document.getElementById("clipContainer").innerHTML = ` 
                <h2>${randomClip.title}</h2>
                <iframe src="${embedUrl}" 
                        frameborder="0" 
                        allowfullscreen="true" 
                        width="560" 
                        height="315">
                </iframe>
            `;
        }

        // Función para enviar un mensaje al chat usando la API de Twitch
        async function sendMessageToChat(message) {
            const url = "https://api.twitch.tv/helix/chat/messages";
            const body = JSON.stringify({
                broadcaster_id: BROADCASTER_ID,
                sender_id: SENDER_ID,
                message: message
            });

            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${ACCESS_TOKEN}`,
                    "Client-Id": CLIENT_ID,
                    "Content-Type": "application/json"
                },
                body: body
            });

            if (response.ok) {
                console.log("Mensaje enviado al chat: ", message);
            } else {
                console.error("Error al enviar mensaje: ", response.statusText);
            }
        }
    </script>

<h2>Chat Logs (Consola)</h2>
<button onclick="processMessage('!so el_afap')">Simular Mensaje</button>

<script>
    // Función para procesar y mostrar el mensaje recibido
    function processMessage(message) {
        const timestamp = new Date().toISOString();  // Obtener la fecha y hora
        const logEntry = `[${timestamp}] Mensaje recibido: ${message}`;
        
        // Mostrar el mensaje en la consola
        console.log(logEntry);

        // Si el mensaje es '!so' seguido de un canal, lo mostramos de manera específica
        if (message.startsWith('!so')) {
            const channelName = message.split(' ')[1];  // Extraer el nombre del canal
            console.log(`[${timestamp}] Mencionando el canal: ${channelName}`);
            sendMessageToChat(`¡Shoutout a ${channelName}!`);
        }
    }
</script>

</body>
</html>
